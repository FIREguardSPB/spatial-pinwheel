# =============================================================================
# Trading Bot - Production CD Workflow
# Triggers on version tags (v*) or manual dispatch
# =============================================================================

name: CD Production

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to deploy (e.g., v1.2.5)'
        required: true
        type: string

env:
  NODE_VERSION: "20"
  PYTHON_VERSION: "3.11"

jobs:
  # ============================================
  # Build Frontend
  # ============================================
  build-frontend:
    name: Build Frontend
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.tag || github.ref }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build production
        run: npm run build
        env:
          VITE_API_BASE_URL: https://trading.chatpsy.online/api

      - name: Upload frontend artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: dist/
          retention-days: 1

  # ============================================
  # Deploy to Production
  # ============================================
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: build-frontend
    environment: production
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.tag || github.ref }}

      - name: Download frontend artifact
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: dist/

      - name: Deploy to VPS via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            echo "üîÑ Deploying Trading Bot..."
            
            # Stop services gracefully
            sudo systemctl stop trading-worker || true
            sudo systemctl stop trading-api || true
            
            # Backup current version
            cd /var/www/trading
            if [ -d "backend" ]; then
              cp -r backend backend.backup.$(date +%Y%m%d_%H%M%S) 2>/dev/null || true
            fi
            
            echo "‚úÖ Services stopped, backup created"

      - name: Copy backend files
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          source: "backend/"
          target: "/var/www/trading/"
          overwrite: true

      - name: Copy frontend files
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          source: "dist/*"
          target: "/var/www/trading/frontend/"
          strip_components: 1
          overwrite: true

      - name: Install dependencies and restart services
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            cd /var/www/trading/backend
            
            # Activate venv and install dependencies
            source venv/bin/activate
            pip install -r requirements.txt --quiet
            
            # Run database migrations (if any)
            # python -m alembic upgrade head
            
            # Fix permissions
            sudo chown -R www-data:www-data /var/www/trading
            
            # Start services
            sudo systemctl start trading-api
            sleep 3
            sudo systemctl start trading-worker
            
            echo "‚úÖ Services started"

      - name: Verify deployment
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            echo "üîç Verifying deployment..."
            
            # Check services
            systemctl is-active trading-api || exit 1
            systemctl is-active trading-worker || exit 1
            
            # Health check
            sleep 5
            curl -sf http://127.0.0.1:8001/health || exit 1
            
            echo "‚úÖ Deployment verified successfully!"

      - name: Notify on failure
        if: failure()
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            echo "‚ö†Ô∏è Deployment failed, attempting rollback..."
            
            # Find latest backup
            BACKUP=$(ls -td /var/www/trading/backend.backup.* 2>/dev/null | head -1)
            
            if [ -n "$BACKUP" ]; then
              rm -rf /var/www/trading/backend
              mv "$BACKUP" /var/www/trading/backend
              sudo systemctl restart trading-api
              sudo systemctl restart trading-worker
              echo "‚úÖ Rollback completed"
            else
              echo "‚ùå No backup found for rollback"
            fi
